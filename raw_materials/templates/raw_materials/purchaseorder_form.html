<!-- purchaseorder_form.html -->
{% extends "base.html" %}

{% block content %}
<h2>{% if object %}Update{% else %}Create{% endif %} Purchase Order</h2>
<form method="post" action="{% url 'purchaseorder_create' %}">
    {% csrf_token %}
    <div class="form-section">
        {{ form.as_p }}
    </div>
    <div class="form-section">
        <h3>Order Lines</h3>
        {{ lines.management_form }}
        <table class="order-lines">
            <thead>
                <tr>
                    <th>Raw Material</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Cost</th>
                    <th>VAT</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="order-lines-body">
                {% for line_form in lines %}
                    <tr class="order-line-form">
                        <td>{{ line_form.raw_material }}</td>
                        <td>{{ line_form.quantity }}</td>
                        <td>{{ line_form.price }}</td>
                        <td class="cost">0.00</td>
                        <td class="vat">0.00</td>
                        <td>
                            <button type="button" class="delete-line">Delete</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="button" id="add-line">Add Line</button>
    </div>
    <div class="form-section">
        <h3>Totals</h3>
        <p>Total Cost: <span id="total-cost">0.00</span></p>
        <p>Total VAT: <span id="total-vat">0.00</span></p>
    </div>
    <button type="submit">Save</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    let formCount = {{ lines.total_form_count }};
    
    $('#add-line').click(function() {
        const newForm = $('.order-line-form:first').clone(false);
        newForm.find('input, select').each(function() {
            const name = $(this).attr('name').replace('-0-', '-' + formCount + '-');
            const id = 'id_' + name;
            $(this).attr({'name': name, 'id': id}).val('');
        });
        $('#order-lines-body').append(newForm);
        formCount++;
        $('#id_form-TOTAL_FORMS').val(formCount);
    });

    $('#order-lines-body').on('click', '.delete-line', function() {
        $(this).closest('.order-line-form').remove();
        formCount--;
        $('#id_form-TOTAL_FORMS').val(formCount);
    });
});
</script>
{% endblock %}
