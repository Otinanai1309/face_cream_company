{% extends "base.html" %}

{% block content %}
<h2>{% if object %}Update{% else %}Create{% endif %} Purchase Order</h2>
<form method="post">
    {% csrf_token %}
    <div class="form-section">
        {{ form.as_p }}
    </div>
    <div class="form-section">
        <h3>Order Lines</h3>
        {{ lines.management_form }}
        <table class="order-lines">
            <thead>
                <tr>
                    <th>Raw Material</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Cost</th>
                    <th>VAT</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for line_form in lines.forms %}
                    <tr class="order-line-form">
                        <td>{{ line_form.raw_material }}</td>
                        <td>{{ line_form.quantity }}</td>
                        <td>{{ line_form.price }}</td>
                        <td class="cost">0.00</td>
                        <td class="vat">0.00</td>
                        <td>
                            <button type="button" class="delete-line">Delete</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="button" id="add-line">Add Line</button>
    </div>
    <div class="form-section">
        <h3>Totals</h3>
        <p>Total Cost: <span id="total-cost">0.00</span></p>
        <p>Total VAT: <span id="total-vat">0.00</span></p>
    </div>
    <button type="submit">Save</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addButton = document.getElementById('add-line');
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');

    addButton.addEventListener('click', addForm);

    function addForm() {
        const formCount = parseInt(totalForms.value, 10);
        const newForm = document.querySelector('.order-line-form').cloneNode(true);
        newForm.innerHTML = newForm.innerHTML.replace(/form-(\d)-/g, `form-${formCount}-`);
        document.querySelector('.order-lines tbody').appendChild(newForm);
        totalForms.value = formCount + 1;
    }

    const deleteButtons = document.querySelectorAll('.delete-line');

    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const form = button.closest('.order-line-form');
            form.remove();
            // Update the management form to reflect the deletion
            const totalForms = document.getElementById('id_form-TOTAL_FORMS');
            totalForms.value = parseInt(totalForms.value, 10) - 1;
        });
    });

    // Calculate totals
    function calculateTotals() {
        console.log("Starting calculateTotals");
        let totalCost = 0;
        let totalVAT = 0;
        document.querySelectorAll('.order-line-form').forEach(form => {
            const quantityInput = form.querySelector('input[name^="form-"][name$="-quantity"]');
            const priceInput = form.querySelector('input[name^="form-"][name$="-price"]');
            
            const quantity = quantityInput ? parseFloat(quantityInput.value) || 0 : 0;
            const price = priceInput ? parseFloat(priceInput.value) || 0 : 0;
            
            console.log(`Quantity: ${quantity}, Price: ${price}`);
            
            const cost = quantity * price;
            const vatRate = 0.24; // Assuming a VAT rate of 24%
            const vat = cost * vatRate;
            
            console.log(`Cost: ${cost}, VAT: ${vat}`);
            
            form.querySelector('.cost').textContent = cost.toFixed(2);
            form.querySelector('.vat').textContent = vat.toFixed(2);
            
            totalCost += cost;
            totalVAT += vat;
        });
        console.log(`Total Cost: ${totalCost}, Total VAT: ${totalVAT}`);
        document.getElementById('total-cost').textContent = totalCost.toFixed(2);
        document.getElementById('total-vat').textContent = totalVAT.toFixed(2);
    }
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', calculateTotals);
    });

    calculateTotals();
});
</script>

<style>
.form-section {
    margin-bottom: 20px;
}
.order-lines {
    width: 100%;
    border-collapse: collapse;
}
.order-lines th, .order-lines td {
    border: 1px solid #ddd;
    padding: 8px;
}
.order-lines th {
    background-color: #f2f2f2;
}
</style>
{% endblock %}